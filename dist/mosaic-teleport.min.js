/*! mosaic-teleport 2014-07-23 */
!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;"undefined"!=typeof window?b=window:"undefined"!=typeof global?b=global:"undefined"!=typeof self&&(b=self),b.mosaicTeleport=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){function c(a){return a&&""!==a?("/"!=a[0]&&(a="/"+a),"/"===a[a.length-1]&&(a=a.substring(0,a.length-1))):a="",a}var d=b.exports=a("mosaic-commons");a("./Mosaic.PathMapper");var e=a("underscore");d.ApiDescriptor=d.Class.extend({initialize:function(){this._config={},this._mapper=new d.PathMapper},add:function(a,b,d){if(e.isObject(a)){var f=a;a=f.path,b=f.http,d=f.method}a=c(a);var g=this._config[a]=this._config[a]||{};return g[b]=d,this._mapper.add(a,g),this},get:function(a){return this._mapper.find(a)},exportJson:function(){var a=[],b={api:a},c=this;return e.each(c._config,function(b,c){e.each(b,function(b,d){a.push({path:c,http:d,method:b})})}),a.sort(function(a,b){return a.path>b.path?1:a.path<b.path?-1:0}),b},importJson:function(a){var b,c=this;b=e.isObject(a)&&e.isArray(a.api)?a.api:e.toArray(a),e.each(b,function(a){c.add(a)})}}),e.extend(d.ApiDescriptor,{normalizePath:c,getDescriptor:function(a){var b=new d.ApiDescriptor,c=d.ApiDescriptor.getDescriptorJson(a);return b.importJson(c),b},getDescriptorJson:function(a){var b=[];return a=e.isFunction(a)?a.prototype:a,e.each(e.functions(a),function(c){var d=a[c];if(d.http&&d.path){var e={method:c,http:d.http,path:d.path};b.push(e)}}),b},bind:function(a,b,c){return c.http=b,c.path=a,c}});var f=d.Class.extend({_wrapHandleMethod:function(a){return function(b,c){var e=this;return d.P.fin(d.P.then(function(){return e._beginHttpCall({req:b,res:c,stub:e})}).then(function(){return a.call(e,b,c)}),function(a,d){return e._endHttpCall({req:b,res:c,stub:e,err:a,result:d})})}},_beginHttpCall:function(a){e.isFunction(this.options.beginHttpCall)&&this.options.beginHttpCall(a)},_endHttpCall:function(a){e.isFunction(this.options.endHttpCall)&&this.options.endHttpCall(a)}});d.ApiDescriptor.HttpServerStub=f.extend({INFO_SUFFIX:".info",registerIn:function(a){var b=this,d=c(this.options.path)+"*";a.all(d,function(a,c){b.handle(a,c).done()})},initialize:function(a){if(this.setOptions(a),this.descriptor=this.options.descriptor,!this.descriptor){var b=this.options.instance||this;this.descriptor=d.ApiDescriptor.getDescriptor(b)}this.options.path=c(this.options.path),this._doHandle=this._wrapHandleMethod(this._doHandle)},getDescriptor:function(){return this.descriptor},handle:function(a,b){var c=this;return d.P.then(function(){return c._doHandle(a,b)}).then(function(a){b.send(200,a||"")},function(a){var c=d.Errors.toJSON(a);c.status=c.status||500,b.send(c.status,c)})},_doHandle:function(a,b){var c=this,e=c._getLocalizedPath(a);if(c._isEndpointInfoPath(e)){var f=c.getEndpointJson();return f}var g=a.method.toLowerCase(),h=c.descriptor.get(e);if(!h)throw d.Errors.newError('Path not found "'+e+'"').code(404);var i=h.obj[g];if(!i)throw d.Errors.newError('HTTP method "'+g.toUpperCase()+'" is not supported. Path: "'+e+'".').code(404);return c._callMethod(a,b,i,h.params)},getEndpointJson:function(){var a=this,b=a.getDescriptor(),c=b.exportJson();return c.endpoint=a.options.path,c},_isEndpointInfoPath:function(a){return a.lastIndexOf(this.INFO_SUFFIX)===a.length-this.INFO_SUFFIX.length},_getInstance:function(){var a=this.options||{},b=a.instance||this;return b},_callMethod:function(a,b,c,e){var f=this,g=f._getInstance(a,b,c,e),h=g[c];if(!h)throw d.Errors.newError('Method "'+c+'" is not implemented').code(500);var i=f._getMethodParams(c,e,a,b);return h.call(g,i)},_getMethodParams:function(a,b,c){return e.extend({},c.query,c.body,c.cookies,b)},_getLocalizedPath:function(a){var b=d.ApiDescriptor.HttpServerStub.getPath(a),c=this.options.path;return b.substring(c.length)}}),d.ApiDescriptor.HttpServerStub.getPath=function(a){var b=a.path;if(!b||""===b){var c=a.url||"",d=c.indexOf("?");d>=0&&(c=c.substring(0,d)),d=c.indexOf("#"),d>=0&&(c=c.substring(0,d)),d=c.indexOf("/"),d>0&&(c=c.substring(d)),b=c}return b},d.ApiDescriptor.HttpClientStub=f.extend({initialize:function(a){if(!a.descriptor)throw d.Errors.newError("API descriptor is not defined").code(501);var b=this;b.setOptions(a),b.descriptor=b.options.descriptor,b.client=b.options.client||b._newHttpClient(),b.handle=b._wrapHandleMethod(b.handle);var c=b.descriptor._config;e.each(c,function(a,c){e.each(a,function(a,d){b[a]=function(a){var e=b._getFullPath(c,a),f=b.client.newRequest({path:e,method:d,params:a}),g=b.client.newResponse(f);return b.handle(f,g)}})})},handle:function(a,b){return this.client.handle(a,b)},_newHttpClient:function(){return a("./Mosaic.HttpClient.Superagent"),new d.HttpClient.Superagent(this.options)},_getFullPath:function(a,b){return d.PathMapper.formatPath(a,b)}}),d.ApiDescriptor.HttpClientStub.load=function(a,b){e.isObject(a)&&(b=a,a=b.baseUrl),b=b||{};var c=new d.HttpClient.Superagent({baseUrl:a}),f=c.newRequest({path:".info"}),g=c.newResponse(f);return c.handle(f,g).then(function(a){var f=a.api,g=new d.ApiDescriptor;return g.importJson(f),new d.ApiDescriptor.HttpClientStub(e.extend(b,{path:a.endpoint,descriptor:g,client:c}))})}},{"./Mosaic.HttpClient.Superagent":3,"./Mosaic.PathMapper":5}],2:[function(a,b){var c=b.exports=a("mosaic-commons"),d=a("underscore");a("./Mosaic.PathMapper"),a("./Mosaic.ApiDescriptor");c.PathMapper;c.ApiDispatcher=c.Class.extend({initialize:function(a){this.setOptions(a),this.options.path=this._normalizePath(this.options.path),this._mapping=new c.PathMapper},addEndpoint:function(a){var b=this;if(!a.instance)throw c.Errors.newError("API implementation is not defined");if(!a.path)throw c.Errors.newError("Path is not defined");var d=b._getEndpointMask(a),e=new c.ApiDescriptor.HttpServerStub(a);b._mapping.add(d,e)},removeEndpoint:function(a){var b=this;d.isString(a)&&(a={path:a});var c=b._getEndpointMask(a);b._mapping.remove(c)},registerIn:function(a){var b=this,c=(b.options.path||"")+"/*";a.all(c,function(a,c){b.handle(a,c).done()})},handle:function(a,b){var d=this;return c.P.then(function(){var b=c.ApiDescriptor.HttpServerStub.getPath(a),e=d._find(b);if(!e){var f=d._loadEndpoint(b);f&&d.addEndpoint(f),e=d._find(b)}return e}).then(function(d){if(d){var e=d.obj;return e.handle(a,b)}throw c.Errors.newError(404,'API handler not found. Path: "'+path+'".')}).then(null,function(a){var d=c.Errors.toJSON(a);d.status=d.status||500,b.send(d.status,d)})},getDescriptorJson:function(a){var b=this,c=b._find(a);if(!c)return null;var d=c.obj,e=d.getEndpointJson();return e},_loadEndpoint:function(){return null},_getEndpointPath:function(a){var b=this,c=b.options.path;return a=c+b._normalizePath(a)},_getEndpointMask:function(a){var b=this._getEndpointPath(a.path);a.path=b;var c=b+"*prefix";return a.mask=c,c},_find:function(a){a=this._normalizePath(a);var b=this._mapping.find(a);return b},_normalizePath:function(a){return a&&""!==a?("/"!=a[0]&&(a="/"+a),"/"===a[a.length-1]&&(a=a.substring(0,a.length-1))):a="",a}})},{"./Mosaic.ApiDescriptor":1,"./Mosaic.PathMapper":5}],3:[function(a,b){var c=b.exports=a("mosaic-commons");a("./Mosaic.HttpClient");var d=a("underscore"),e=a("superagent");c.HttpClient.Superagent=c.HttpClient.extend({initialize:function(a){var b=c.HttpClient.prototype.initialize;b.call(this,a)},http:function(a,b,c){var f=(a.method||"get").toLowerCase();"delete"==f&&(f="del"),f=f.toLowerCase();var g=e[f](a.url);this.options.formEncoded&&g.type("form");var h=d.extend({},this.options.headers,a.headers);g.set(h);var i=d.extend({},this.options.query,a.query);g.query(i);var j=d.extend({},this.options.body,a.body);g=g.send(j),g.end(function(a,e){try{e?(b.status=e.status,d.extend(b.headers,e.headers||{}),b.body=e.body):b.status=a&&a.status?a.status:500,c(a)}catch(f){c(f)}})}})},{"./Mosaic.HttpClient":4}],4:[function(a,b){var c=b.exports=a("mosaic-commons"),d=a("underscore");c.HttpClient=c.Class.extend({initialize:function(a){if(this.setOptions(a),!this.options.baseUrl)throw c.Errors.newError('The "baseUrl" is not defined.').code(501)},handle:function(a,b){var e=this,f=c.P.defer();try{e.http(a,b,function(a){try{if(!a){var e=parseInt(b.status)/100;if(e=100*parseInt(e),200!=e)if(b.body&&b.body.trace){a=c.Errors.fromJSON(b.body).code(b.status);var g=d.isArray(b.body.trace)?b.body.trace.join("\n"):""+b.body.trace;a.stack=g+"\n\n"+a.stack}else a=c.Errors.newError("Error: "+b.status).code(b.status)}if(a)throw a;f.resolve(b.body)}catch(h){f.reject(h)}})}catch(g){f.reject(g)}return f.promise},newRequest:function(a){return a=a||{},a.id=d.uniqueId("req-"),a.method=(a.method||"get").toUpperCase(),a.params=a.params||{},a.body=a.body||a.params||{},a.url=this._toUrl(a.path),a.query=a.query||{},a.headers=a.headers||{},a},newResponse:function(a){return{id:a.id,status:200,headers:{},body:null,error:null}},_toUrl:function(a){var b=this.options||{},c=b.baseUrl||"";return c+a},http:function(a,b,d){var e=c.Errors.newError("Not implemented");d(e)}})},{}],5:[function(a,b){function c(a){return a.replace(h,"\\$&")}function d(a){return"("+a+")"}var e=b.exports=a("mosaic-commons"),f=a("underscore"),g=e.PathMapper=e.Class.extend({initialize:function(){var a=this;a.handlers=[]},add:function(a,b){var e=this,g=[],h=[],i=!1;f.each(a.split("*"),function(a){var b=!1;f.each(a.split(":"),function(a){if(i||b){if(i||b){var e=a.indexOf("/"),f=b?"[^/]+":".*?";e>=0?(g.push(d(f)),h.push(a.substring(0,e)),g.push(c(a.substring(e)))):(g.push(d(f)),h.push(a))}}else g.push(c(a));b=!0}),i=!0});var j=g.join(""),k=new RegExp("^"+j+"$");e.handlers.push({mask:a,regexp:k,names:h,obj:b})},find:function(a){var b=this,c=null;return f.any(b.handlers,function(b){if(b.regexp.test(a)){var d={},e=b.regexp.exec(a).slice(1),g=0;return f.each(e,function(a){var c=b.names[g++],e=a?decodeURIComponent(a):null;d[c]=e}),c={params:d,obj:b.obj},!0}}),c},remove:function(a){var b=this,c=null;return b.handlers=f.filter(b.handlers,function(b){var d=!0;return b.mask===a&&(c=b.obj,d=!1),d}),c}});g.formatPath=function(a,b){b=b||{};for(var c=a.split(/[:\*]/gim),d=[],e=0;e<c.length;e++){var f=c[e];if(0===e)""!==f&&d.push(f);else{var g=null,h=f.indexOf("/");h>=0?(g=f.substring(0,h),f=f.substring(h)):(g=f,f=null);var i=b[g];if(!i){var j='Required parameter "'+g+'" not defined.',k=new Error(j);throw k._code=400,k}delete b[g],d.push(i),f&&""!==f&&d.push(f)}}return d.join("")};var h=/[\-{}\[\]+?.,\\\^$|#\s]/g},{}],6:[function(a,b){b.exports=a("mosaic-commons"),a("./Mosaic.ApiDescriptor"),a("./Mosaic.ApiDispatcher"),a("./Mosaic.PathMapper"),a("./Mosaic.HttpClient"),a("./Mosaic.HttpClient.Superagent")},{"./Mosaic.ApiDescriptor":1,"./Mosaic.ApiDispatcher":2,"./Mosaic.HttpClient":4,"./Mosaic.HttpClient.Superagent":3,"./Mosaic.PathMapper":5}]},{},[6])(6)});